"""规定该库所拥有的属性。定义处理属性的方法。定义将属性存储到内存中的方法。"""


import uuid
from app.objects.interfaces.i_object import FirstClassObjectInterface
from app.utility.base_object import BaseObject
import marshmallow as ma
from marshmallow import fields, validate
class VulnerabilitySchema(ma.Schema):

    # Meta 是Schema的内置类，用于管理Schema的配置选项
    class Meta:
        # unknow为规定的属性。ma.EXCLUDE 表示在反序列化时忽略未知字段，即如果输入数据中包含Schema中未定义的字段，这些字段将被忽略
        unknown = ma.EXCLUDE

    vulnerability_id = ma.fields.String()
    name = ma.fields.String()
    risk = fields.String(
        validate=validate.OneOf(["Low", "Medium", "High"])
    )
    product = ma.fields.String()
    description = ma.fields.String()
    cve = ma.fields.String()
    cvss_v3 = ma.fields.Float()
    # @ma.post_load表示：在marshmallow调用load反序列化后所执行的方法
    @ma.post_load
    def build_profile(self, data, **kwargs): # 根据返序列化的结果构建Vulnerability对象
        """
        data和**kargs 是marshmallow反序列化后传递过来的参数，
        即def build_profile(self, data, **kwargs):函数中，第二个参数data和第三个参数**kwargs是由marshmallow所规定传递的
        data表示反序列化后的数据，**kwargs表示_load的关键字参数。
        """
        return None if kwargs.get('partial') is True else Vulnerability(**data)

class Vulnerability(FirstClassObjectInterface,BaseObject):
    schema = VulnerabilitySchema()

    def __init__(self, vulnerability_id=None, name='', product='', cve='', cvss_v3=0.0, risk = 'Medium', description='', **extras):
        super().__init__()
    
        self.vulnerability_id = vulnerability_id or str(uuid.uuid4())
        self.name = name
        self.product= product
        self.description = description or ''
        self.risk = risk or 'Medium'
        self.cve = cve or ''
        self.cvss_v3 = cvss_v3 or 0.0
        self.access = self.Access.RED

        for k, v in extras.items():
            setattr(self, k, v)

    @property
    def unique(self):
        return self.hash('%s' % self.vulnerability_id)

    def store(self, ram):
        existing = self.retrieve(ram['vulnerabilities'], self.unique)
        
        if not existing:
            ram['vulnerabilities'].append(self)
            return self.retrieve(ram['vulnerabilities'], self.unique)
        existing.update('name', self.name)
        existing.update('product', self.product)
        existing.update('description', self.description)
        existing.update('cve', self.cve)
        existing.update('risk', self.risk)
        existing.update('cvss_v3', self.cvss_v3)
        return existing


    def search_tags(self, value):
        """用于 DataService.search() 的标签匹配"""
        return any(value.lower() in str(t).lower() for t in (self.tags or []))


    @property
    def unique(self):
        return self.hash('%s' % self.vulnerability_id)

    def store(self, ram):
        existing = self.retrieve(ram['vulnerabilities'], self.unique)
        
        if not existing:
            ram['vulnerabilities'].append(self)
            return self.retrieve(ram['vulnerabilities'], self.unique)
        existing.update('name', self.name)
        existing.update('product', self.product)
        existing.update('description', self.description)
        existing.update('cve', self.cve)
        existing.update('risk', self.risk)
        existing.update('cvss_v3', self.cvss_v3)
        return existing


    def search_tags(self, value):
        """用于 DataService.search() 的标签匹配"""
        return any(value.lower() in str(t).lower() for t in (self.tags or []))
