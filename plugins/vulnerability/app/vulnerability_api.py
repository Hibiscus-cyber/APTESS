from pathlib import Path
import asyncio, uuid, re, yaml, shutil

import pathlib
import json 
import aiohttp_apispec 
from aiohttp import web 
from app.api.v2.handlers.base_object_api import BaseObjectApi 
from .vulnerability_api_manager import VulnerabilityApiManager
from app.api.v2.schemas.base_schemas import BaseGetAllQuerySchema, BaseGetOneQuerySchema 
from app.objects.c_vulnerability import VulnerabilitySchema, Vulnerability 

class VulnerabilityApi(BaseObjectApi):
    def __init__(self, services):
        super().__init__(description='vulnerability',obj_class=Vulnerability, schema=VulnerabilitySchema, ram_key='vulnerabilities', id_property='vulnerability_id', auth_svc=services['auth_svc']) 
        self._api_manager = VulnerabilityApiManager(data_svc=services['data_svc'], file_svc=services['file_svc'])
        self._data_svc = services['data_svc']
    async def options_ok(request): return web.Response() 

    def add_routes(self, app: web.Application):
        router = app.router
        vulnerabilities_by_id_path = '/api/v2/vulnerabilities/{vulnerability_id}' 
        router.add_get('/api/v2/vulnerabilities', self.get_vulnerabilities) 
        router.add_get(vulnerabilities_by_id_path, self.get_vulnerability_by_id) 
        router.add_post('/api/v2/vulnerabilities', self.create_vulnerability) 
        router.add_delete('/api/v2/vulnerabilities/by-name/{name}', self.delete_on_disk_object_by_name) 

    @aiohttp_apispec.docs(tags=['vulnerabilities'], summary='Get all vulnerabilities.', description='Provides a list of all available vulnerabilities.') 
    @aiohttp_apispec.querystring_schema(BaseGetAllQuerySchema) 
    @aiohttp_apispec.response_schema(VulnerabilitySchema(many=True, partial=True), description='Returns a list of all vulnerabilities.') 
    
    async def get_vulnerabilities(self, request: web.Request): 
        vulnerabilities = await self.get_all_objects(request) 
        return web.json_response(vulnerabilities) 

    async def get_vulnerability_by_id(self, request: web.Request): 
        vulnerability = await self.get_object(request) 
        return web.json_response(vulnerability)


    async def create_vulnerability(self, request: web.Request):
        vulnerability = await self.create_on_disk_object(request)
        return web.json_response(vulnerability.display)

    async def delete_vulnerability(self, request: web.Request):
        await self.delete_on_disk_object(request)
        return web.HTTPNoContent()

    async def delete_on_disk_object_by_name(self, request: web.Request):
        name = request.match_info['name']

        # 1) 先找出所有同名对象（为了拿到它们的 id 做磁盘删除）
        items = await self._data_svc.locate(self.ram_key, {'name': name})
        if not items:
            return web.json_response(
                {'status': 'error', 'error': f'{self.ram_key} named "{name}" not found'},
                status=404
            )

        # 2) 先从 RAM 删除所有 name 命中的对象
        await self._data_svc.remove(self.ram_key, {'name': name})

        # 3) 再逐个按 id 从磁盘删除
        deleted_ids = []
        for obj in items:
            obj_id = getattr(obj, self.id_property, None) or getattr(obj, 'id', None)
            if obj_id:
                await self._api_manager.remove_object_from_disk_by_id(
                    identifier=obj_id,
                    ram_key=self.ram_key
                )
                deleted_ids.append(obj_id)

        return web.json_response({
            'status': 'success',
            'deleted_name': name,
            'count': len(items),
            'deleted_ids': deleted_ids
        })
