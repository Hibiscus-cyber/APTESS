<script setup>
import { storeToRefs } from "pinia";
import { reactive, inject, onMounted, computed } from "vue";
import { useRoute } from "vue-router";
import { useVulnerabilityStore } from "@/stores/vulnerabilityStore";

import { useCoreDisplayStore } from "@/stores/coreDisplayStore";
//import UploadModal from "@/components/profile/UploadProfile.vue";
// TODO: 1.修改DisplaySotre 2、子页面的Vue设计 3、修改当前页面文本 4、修改API路径

const $api = inject("$api");
const route = useRoute();
const vulnerabilityStore = useVulnerabilityStore();
const { vulnerabilities } = storeToRefs(vulnerabilityStore);
const coreDisplayStore = useCoreDisplayStore();
const { modals } = storeToRefs(coreDisplayStore);

let validation = reactive({
  name: 'Demo Vulnerability',
  platform: 'Windows 7',
  description: 'just a demo vulnerability item!',
  risk: "high",
  tags: "[red, demo]"
});

let filters = reactive({
    searchQuery: "",
    name: "",
});


//实现过滤器功能
const filteredVulnerabilities = computed(() => {
  return vulnerabilities.value.filter((v) => (
    v.name?.toLowerCase().includes(filters.searchQuery.toLowerCase()) &&
    (!filters.name || v.name === filters.name)
  ));
});

onMounted(async () => {
    await vulnerabilityStore.getVulnerabilities($api);
    filters.name = route.query.name || "";
});

function clearFilters() {
    Object.keys(filters).forEach((k) => filters[k] = "");
}

function selectVulnerability(vulnerability){
  console.log('selected vulnerability:', vulnerability?.vulnerability_id);
}
function validateAndSave() {
  vulnerabilityStore.saveVulnerability($api, validation);  
}
</script>

<template lang="pug">
.content
  h2 漏洞库
  p 漏洞库中展示平台中可用的漏洞信息。您可以搜索和筛选现有漏洞以便使用。
hr

.box.mb-4
  .is-flex.is-align-items-center.is-flex-wrap-wrap
    // 新建载荷按钮
    button.button.is-primary.mr-3.mb-2(@click="modals.vulnerability.showUpload = true")
      span.icon
        font-awesome-icon(icon="fas fa-plus")
      span 新建漏洞

    // 搜索框
    .field.has-addons.mr-3.mb-2
      .control.has-icons-left
        input.input.is-small(v-model="filters.searchQuery" type="text" placeholder="搜索漏洞…")
        span.icon.is-left
          font-awesome-icon(icon="fas fa-search")



    // 清除按钮与计数
    button.button.is-light.is-small.mr-3.mb-2(@click="clearFilters()") 清除筛选
    p.help.mb-0.mt-0 {{ filteredVulnerabilities.length }} / {{ vulnerabilities.length }} 个漏洞

.columns.is-multiline
  .column.is-12-mobile.is-6-tablet.is-4-desktop.is-3-widescreen(
    v-for="vulnerability in filteredVulnerabilities"
    :key="vulnerability.vulnerability_id"
  )
    .box.p-3.ability(@click="selectVulnerability(vulnerability)")
      .is-flex.is-justify-content-space-between.is-align-items-center.mb-1
        .is-flex
      strong {{ vulnerability.name }}
      p.help.mb-0 {{ vulnerability.description }}

UploadModal
</template>




<style scoped>
/* === 容器：统一行高 + 拉伸卡片 === */
.abilities{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(520px, 1fr)); /* 每卡至少 520px 宽 */
  gap: 12px;
  overflow-x: hidden; /* 保留你的设定 */
  align-items: stretch;                 /* 让格子里的元素拉满行高 */
  grid-auto-rows: 170px;                /* ✅ 统一每一行的高度（可按需调 150~200） */
}

/* 旧的 width 媒体查询会干扰自适应，覆盖为 100% */
@media (max-width: 2400px){ .box.ability{ width: 100% !important; } }
@media (min-width: 1200px){ .box.ability{ width: 100% !important; } }

/* === 卡片：占满格子高度，变成扁长形，内容竖直排布 === */
.box.ability{
  position: relative;
  cursor: pointer;
  border: 1px solid transparent;
  background-color: #272727;
  display: flex;               /* 竖向布局 */
  flex-direction: column;
  height: 100%;                /* ✅ 撑满格子的统一行高 */
  padding: 12px 16px;
  border-radius: 16px;
  transition: box-shadow .12s ease, border-color .12s ease, transform .08s ease;
}
.box.ability:hover{
  border: 1px solid #474747;
  box-shadow: 0 4px 12px rgba(0,0,0,.18);
  transform: translateY(-1px);
}

/* 顶部 meta 行（战术标签 / 技术ID） */
.box.ability > .is-flex{
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

/* 标题占一行或两行，底部留出空间给描述 */
.box.ability strong{
  font-weight: 800;
  line-height: 1.2;
  margin-bottom: 6px;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;          /* 标题最多 2 行，可调为 1 */
  -webkit-box-orient: vertical;
}

/* 描述固定两行，超出省略，保证所有卡片同高 */
.box.ability p.help.mb-0{
  opacity: .9;
  line-height: 1.35;
  margin: 0;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;          /* ✅ 描述两行 */
  -webkit-box-orient: vertical;
}

/* 小优化 */
.box.ability .tag.is-small{ margin-right: 8px; }
.box.ability p.help.mt-0{ white-space: nowrap; opacity: .8; margin-left: 8px; }

/* 不同屏宽下的列宽与统一行高可微调 */
@media (max-width: 1440px){
  .abilities{ grid-template-columns: repeat(auto-fill, minmax(440px, 1fr)); grid-auto-rows: 180px; }
}
@media (max-width: 1024px){
  .abilities{ grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); grid-auto-rows: 190px; }
}
@media (max-width: 640px){
  .abilities{ grid-template-columns: 1fr; grid-auto-rows: 200px; } /* 手机上一列更高一点 */
}

</style>
